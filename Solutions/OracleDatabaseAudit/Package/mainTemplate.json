{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Manish Kumar - maniskumar@microsoft.com",
    "comments": "Solution template for OracleDatabaseAudit"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "OracleDatabaseAudit",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "b529fc21-7ace-4081-8248-880cb6e8ac73"
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    }
  },
  "variables": {
    "OracleDatabaseAudit": "OracleDatabaseAudit",
    "_OracleDatabaseAudit": "[variables('OracleDatabaseAudit')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "OracleDBAuditConnectFromExternalIp": "OracleDBAuditConnectFromExternalIp",
    "_OracleDBAuditConnectFromExternalIp": "[variables('OracleDBAuditConnectFromExternalIp')]",
    "OracleDBAuditDropManyTables": "OracleDBAuditDropManyTables",
    "_OracleDBAuditDropManyTables": "[variables('OracleDBAuditDropManyTables')]",
    "OracleDBAuditForbiddenSrcIpAddr": "OracleDBAuditForbiddenSrcIpAddr",
    "_OracleDBAuditForbiddenSrcIpAddr": "[variables('OracleDBAuditForbiddenSrcIpAddr')]",
    "OracleDBAuditNewIpForUser": "OracleDBAuditNewIpForUser",
    "_OracleDBAuditNewIpForUser": "[variables('OracleDBAuditNewIpForUser')]",
    "OracleDBAuditNewUserDetected": "OracleDBAuditNewUserDetected",
    "_OracleDBAuditNewUserDetected": "[variables('OracleDBAuditNewUserDetected')]",
    "OracleDBAuditQueryOnSensitiveTable": "OracleDBAuditQueryOnSensitiveTable",
    "_OracleDBAuditQueryOnSensitiveTable": "[variables('OracleDBAuditQueryOnSensitiveTable')]",
    "OracleDBAuditRareUserActivity": "OracleDBAuditRareUserActivity",
    "_OracleDBAuditRareUserActivity": "[variables('OracleDBAuditRareUserActivity')]",
    "OracleDBAuditSQLInjectionPatterns": "OracleDBAuditSQLInjectionPatterns",
    "_OracleDBAuditSQLInjectionPatterns": "[variables('OracleDBAuditSQLInjectionPatterns')]",
    "OracleDBAuditSelectOnManyTables": "OracleDBAuditSelectOnManyTables",
    "_OracleDBAuditSelectOnManyTables": "[variables('OracleDBAuditSelectOnManyTables')]",
    "OracleDBAuditShutdownServer": "OracleDBAuditShutdownServer",
    "_OracleDBAuditShutdownServer": "[variables('OracleDBAuditShutdownServer')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "OracleDatabaseAuditConnector": "OracleDatabaseAuditConnector",
    "_OracleDatabaseAuditConnector": "[variables('OracleDatabaseAuditConnector')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "OracleDatabaseAuditEvent": "OracleDatabaseAuditEvent",
    "_OracleDatabaseAuditEvent": "[variables('OracleDatabaseAuditEvent')]",
    "OracleDBAuditActionsByIp": "OracleDBAuditActionsByIp",
    "_OracleDBAuditActionsByIp": "[variables('OracleDBAuditActionsByIp')]",
    "OracleDBAuditActionsByUser": "OracleDBAuditActionsByUser",
    "_OracleDBAuditActionsByUser": "[variables('OracleDBAuditActionsByUser')]",
    "OracleDBAuditActiveUsers": "OracleDBAuditActiveUsers",
    "_OracleDBAuditActiveUsers": "[variables('OracleDBAuditActiveUsers')]",
    "OracleDBAuditDbConnectNonOperationalTime": "OracleDBAuditDbConnectNonOperationalTime",
    "_OracleDBAuditDbConnectNonOperationalTime": "[variables('OracleDBAuditDbConnectNonOperationalTime')]",
    "OracleDBAuditDroppedTables": "OracleDBAuditDroppedTables",
    "_OracleDBAuditDroppedTables": "[variables('OracleDBAuditDroppedTables')]",
    "OracleDBAuditInactiveUsers": "OracleDBAuditInactiveUsers",
    "_OracleDBAuditInactiveUsers": "[variables('OracleDBAuditInactiveUsers')]",
    "OracleDBAuditLargeQueries": "OracleDBAuditLargeQueries",
    "_OracleDBAuditLargeQueries": "[variables('OracleDBAuditLargeQueries')]",
    "OracleDBAuditListOfTablesQueried": "OracleDBAuditListOfTablesQueried",
    "_OracleDBAuditListOfTablesQueried": "[variables('OracleDBAuditListOfTablesQueried')]",
    "OracleDBAuditUsersNewPrivilegesAdded": "OracleDBAuditUsersNewPrivilegesAdded",
    "_OracleDBAuditUsersNewPrivilegesAdded": "[variables('OracleDBAuditUsersNewPrivilegesAdded')]",
    "OracleDBAuditUsersPrivilegesReview": "OracleDBAuditUsersPrivilegesReview",
    "_OracleDBAuditUsersPrivilegesReview": "[variables('OracleDBAuditUsersPrivilegesReview')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-oracledbaudit",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2021-08-01",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**: This workbook depends on a parser based on Kusto Function to work as expected [**OracleDatabaseAuditEvent**](https://aka.ms/sentinel-OracleDatabaseAudit-parser) which is deployed with the Azure Sentinel Solution.\",\"style\":\"info\"},\"name\":\"text - 9\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"88aa96e3-fc48-4b04-836e-fc2ec8ebf37f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\" Time Range\",\"type\":4,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":3600000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Events over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"customWidth\":\"70\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\r\\n| where isnotempty(DbAction)\\r\\n| summarize TotalEvents = count() by DbAction\",\"size\":3,\"title\":\"Top Database Actions\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"EventSeverity\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},\"leftContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":true,\"rowLimit\":7,\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"EventSeverity\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"30\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\r\\n| where isnotempty(DstUserName)\\r\\n| summarize TotalEvents = count() by DstUserName\\r\\n| order by TotalEvents\\r\\n| take 10\",\"size\":3,\"title\":\"Database Users Activity (Events)\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\r\\n| where isnotempty(SrcUserName)\\r\\n| summarize TotalEvents = count() by SrcUserName\\r\\n\",\"size\":3,\"title\":\"Source Users Activity (Events)\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEvents\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}],\"rowLimit\":10,\"labelSettings\":[{\"columnId\":\"TotalEvents\",\"label\":\"Total Events\"},{\"columnId\":\"Trend\"}]}},\"customWidth\":\"31\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\r\\n| where isnotempty(SrcDvcHostname)\\r\\n| summarize TotalEvents = count() by SrcDvcHostname\\r\\n| join kind = inner (OracleDatabaseAuditEvent\\r\\n | where isnotempty(SrcDvcHostname)\\r\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcDvcHostname)\\r\\n on SrcDvcHostname\\r\\n| project SrcDvcHostname, TotalEvents, Trend\\r\\n| order by TotalEvents\\r\\n| top 10 by TotalEvents\",\"size\":3,\"title\":\"Top Source Hosts\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEvents\",\"formatter\":8,\"formatOptions\":{\"palette\":\"turquoise\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\"}}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"SrcDvcHostname\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"33\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\n| where DbAction =~ 'SELECT'\\n| extend TableName = replace(@'[,\\\\(\\\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\\\s(.*?)\\\\s', 2, Action))\\n| where isnotempty(TableName)\\n| where TableName !in ('select', 'SELECT')\\n| summarize count() by TableName\\n| order by count_\\n\\n\\n\",\"size\":0,\"title\":\"Database Tables Queried\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"EventCategory\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false,\"rowLimit\":10},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"TableName\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"TableName\",\"sourceIdField\":\"TableName\",\"targetIdField\":\"count_\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"xSettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\r\\n| where TimeGenerated > ago(30d)\\r\\n| order by TimeGenerated\\r\\n| where isnotempty(SrcUserName)\\r\\n| where isnotempty(DbAction)\\r\\n| summarize EventTime = max(TimeGenerated) by SrcUserName, DbAction\\r\\n| order by EventTime desc\\r\\n| join (OracleDatabaseAuditEvent\\r\\n    | where TimeGenerated > ago(30d)\\r\\n    | order by TimeGenerated\\r\\n    | where isnotempty(SrcUserName)\\r\\n    | where isnotempty(DbAction)\\r\\n    | summarize by SrcUserName) on SrcUserName\\r\\n| project EventTime, SrcUserName, DbAction\\r\\n\\r\\n\",\"size\":1,\"title\":\"Latest User Actions\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"rowLimit\":100,\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleDatabaseAuditEvent\\r\\n| where isnotempty(SrcUserName)\\r\\n| where isnotempty(Privilege)\\r\\n| summarize Privileges = makeset(Privilege) by SrcUserName\",\"size\":1,\"title\":\"Users' Privileges\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"rowLimit\":100,\"filter\":true},\"graphSettings\":{\"type\":0,\"leftContent\":{\"columnMatch\":\"SrcUserName\"},\"centerContent\":{\"columnMatch\":\"SrcUserName\",\"formatter\":1},\"bottomContent\":{\"columnMatch\":\"set_Privilege\",\"formatter\":1},\"nodeIdField\":\"set_Privilege\",\"sourceIdField\":\"SrcUserName\",\"targetIdField\":\"SrcUserName\",\"graphOrientation\":1,\"showOrientationToggles\":false,\"staticNodeSize\":100,\"groupByField\":\"SrcUserName\",\"hivesMargin\":5},\"mapSettings\":{\"locInfo\":\"LatLong\"}},\"customWidth\":\"39\",\"name\":\"query - 8\"}],\"fromTemplateId\":\"sentinel-OracleDatabaseAudit\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Oracle Database Audit",
          "publisher": "Oracle",
          "descriptionMarkdown": "The Oracle DB Audit data connector provides the capability to ingest [Oracle Database](https://www.oracle.com/database/technologies/) audit events into Azure Sentinel through the syslog. Refer to [documentation](https://docs.oracle.com/en/database/oracle/oracle-database/21/dbseg/introduction-to-auditing.html#GUID-94381464-53A3-421B-8F13-BD171C867405) for more information.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "OracleDatabaseAudit",
              "baseQuery": "OracleDatabaseAuditEvent"
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Sources",
              "query": "OracleDatabaseAuditEvent\n | summarize count() by SrcDvcHostname\n | top 10 by count_"
            }
          ],
          "dataTypes": [
            {
              "name": "Syslog (OracleDatabaseAudit)",
              "lastDataReceivedQuery": "OracleDatabaseAuditEvent\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "OracleDatabaseAuditEvent\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "delete": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**OracleDatabaseAuditEvent**](https://aka.ms/sentinel-OracleDatabaseAudit-parser) which is deployed with the Azure Sentinel Solution."
            },
            {
              "description": "Typically, you should install the agent on a different computer from the one on which the logs are generated.\n\n>  Syslog logs are collected only from **Linux** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "1. Install and onboard the agent for Linux"
            },
            {
              "description": "Configure the facilities you want to collect and their severities.\n\n1.  Under workspace advanced settings **Configuration**, select **Data** and then **Syslog**.\n2.  Select **Apply below configuration to my machines** and select the facilities and severities.\n3.  Click **Save**.",
              "instructions": [
                {
                  "parameters": {
                    "linkType": "OpenAdvancedWorkspaceSettings"
                  },
                  "type": "InstallAgent"
                }
              ],
              "title": "2. Configure the logs to be collected"
            },
            {
              "description": "[Follow these instructions](https://docs.oracle.com/en/database/oracle/oracle-database/21/dbseg/administering-the-audit-trail.html#GUID-662AA54B-D878-4B78-94D3-733256B3F37C) to configure Oracle Database Audit events to be sent to Syslog.\nFor more information please refer to [documentation](https://docs.oracle.com/en/database/oracle/oracle-database/21/dbseg/administering-the-audit-trail.html)",
              "title": "3. Configure Oracle Database Audit events to be sent to Syslog"
            }
          ],
          "additionalRequirementBanner": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**OracleDatabaseAuditEvent**](https://aka.ms/sentinel-OracleDatabaseAudit-parser) which is deployed with the Azure Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when connection to database is from external IP source.",
        "displayName": "OracleDBAudit - Connection to database from external IP",
        "enabled": false,
        "query": "OracleDatabaseAuditEvent\n| where isnotempty(SrcIpAddr)\n| where isnotempty(Action)\n| where DbAction =~ 'connect'\n| where ipv4_is_private(SrcIpAddr) == 'false'\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT30M",
        "queryPeriod": "PT30M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Collection",
          "Exfiltration"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when user drops many tables in short period of time.",
        "displayName": "OracleDBAudit - Multiple tables dropped in short time",
        "enabled": false,
        "query": "let tbl_threshold = 10;\nOracleDatabaseAuditEvent\n| where isnotempty(DstUserName)\n| where DbAction =~ 'DROP'\n| extend TableName = replace(@'[,\\(\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\s(.*?)\\s', 2, Action))\n| where isnotempty(TableName)\n| where TableName !~ 'SELECT'\n| summarize tbl_count = dcount(TableName) by DstUserName\n| where tbl_count > tbl_threshold\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT30M",
        "queryPeriod": "PT30M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Impact"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when user connects to a database from IP address which is not present in AllowList.",
        "displayName": "OracleDBAudit - Connection to database from unknown IP",
        "enabled": false,
        "query": "let ip_allowlist = dynamic(['127.0.0.2']);\nOracleDatabaseAuditEvent\n| where isnotempty(SrcIpAddr)\n| where DbAction =~ 'CONNECT'\n| where SrcIpAddr !in (ip_allowlist)\n| project SrcIpAddr, DstUserName\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when a user connects to database from new IP address.",
        "displayName": "OracleDBAudit - User connected to database from new IP",
        "enabled": false,
        "query": "let lbtime_d = 14d;\nlet lbtime_24h = 24h;\nOracleDatabaseAuditEvent\n| where TimeGenerated between (ago(lbtime_d) .. ago(lbtime_24h))\n| where isnotempty(SrcIpAddr)\n| where isnotempty(DstUserName)\n| summarize knownIPs = make_set(SrcIpAddr) by DstUserName\n| join (OracleDatabaseAuditEvent\n      | where isnotempty(SrcIpAddr)\n      | where isnotempty(DstUserName)\n      | where DbAction =~ 'connect'\n      ) on DstUserName\n| where knownIPs !contains SrcIpAddr\n| project DstUserName, SrcIpAddr\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "P14D",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when an action was made by new user.",
        "displayName": "OracleDBAudit - New user account",
        "enabled": false,
        "query": "let lbtime_d = 14d;\nlet lbtime_24h = 24h;\nlet known_users = OracleDatabaseAuditEvent\n| where TimeGenerated between (ago(lbtime_d) .. ago(lbtime_24h))\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| summarize makeset(DstUserName);\nOracleDatabaseAuditEvent\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| where DstUserName !in (known_users)\n| project DstUserName\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT3H",
        "queryPeriod": "P14D",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Persistence"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when user queries sensitive tables.",
        "displayName": "OracleDBAudit - Query on Sensitive Table",
        "enabled": false,
        "query": "let sensitive_tbls = dynamic(['table_name1', 'table_name2']);\nOracleDatabaseAuditEvent\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| extend TableName = replace(@'[,\\(\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\s(.*?)\\s', 2, Action))\n| where isnotempty(TableName)\n| where TableName in (sensitive_tbls)\n| project TableName, DstUserName, DbAction\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT30M",
        "queryPeriod": "PT30M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Collection"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when an action was made by a user which last activity was observed more than 30 days ago.",
        "displayName": "OracleDBAudit - User activity after long inactivity time",
        "enabled": false,
        "query": "let lbtime_14d = 14d;\nlet lbtime_7d = 7d;\nlet lbtime_24h = 24h;\nlet known_users_14d = OracleDatabaseAuditEvent\n| where TimeGenerated between (ago(lbtime_14d) .. ago(lbtime_14d))\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| summarize makeset(DstUserName);\nlet known_users_7d = OracleDatabaseAuditEvent\n| where TimeGenerated between (ago(lbtime_7d) .. ago(lbtime_24h))\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| summarize makeset(DstUserName);\nOracleDatabaseAuditEvent\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| where DstUserName !in (known_users_7d)\n| where DstUserName in (known_users_14d)\n| project DstUserName\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Persistence"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects common known SQL injection patterns used in automated scripts.",
        "displayName": "OracleDBAudit - SQL injection patterns",
        "enabled": false,
        "query": "OracleDatabaseAuditEvent\n| where isnotempty(DstUserName)\n| where Action has_any (\"admin' --\" ,\"admin' #\", \"admin'/*\", \"0=1\", \"1=0\", \"1=1\", \"1=2\", \"' or 1=1--\", \"' or 1=1#\", \"' or 1=1/*\", \"') or '1'='1--\", \"') or ('1'='1--\")\n| project SrcIpAddr, DstUserName, Action\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when user queries many tables in short period of time.",
        "displayName": "OracleDBAudit - Unusual user activity on multiple tables",
        "enabled": false,
        "query": "let tbl_threshold = 10;\nOracleDatabaseAuditEvent\n| where isnotempty(DstUserName)\n| where DbAction =~ 'SELECT'\n| extend TableName = replace(@'[,\\(\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\s(.*?)\\s', 2, Action))\n| where isnotempty(TableName)\n| where TableName !~ 'SELECT'\n| summarize tbl_count = dcount(TableName) by DstUserName, bucket = bin(TimeGenerated, 5m)\n| where tbl_count > tbl_threshold\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Collection"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when \"SHUTDOWN\" command was sent to server.",
        "displayName": "OracleDBAudit - Shutdown Server",
        "enabled": false,
        "query": "OracleDatabaseAuditEvent\n| where isnotempty(SrcIpAddr)\n| where DbAction =~ 'SHUTDOWN'\n| project SrcIpAddr, DstUserName\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Impact"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDatabaseAudit Data Parser",
            "category": "Samples",
            "functionAlias": "OracleDatabaseAuditEvent",
            "query": "\nlet oracledb_type_1 =() {\nSyslog\n| where SyslogMessage matches regex @\".*ACTION(\\s)?:\\[\\d+\\]\\s\\'(.*?)\\s\"\n| extend EventVendor = 'Oracle'\n| extend EventProduct = 'Oracle Audit'\n| extend MessageLength = extract(@\"LENGTH(\\s)?: \\'(\\d+)\\'\", 2, SyslogMessage)\n| extend Action = extract(@\"ACTION(\\s)?:\\[\\d+\\] \\'(.*?)\\'\\s+DATABASE USER\", 2, SyslogMessage)\n| extend ActionLength = extract(@\"ACTION(\\s)?:\\[(\\d+)\\] \\'(.*?)\\'\\s+DATABASE USER\", 2, SyslogMessage)\n| extend DbAction = toupper(extract(@\"ACTION(\\s)?:\\[\\d+\\] \\'(?i)(SELECT|CREATE|ALTER|DROP|read|declare|BEGIN|Copy|CONNECT|COMMIT)(\\s|\\')\", 2, SyslogMessage))\n| extend DstUserName = extract(@\"DATABASE USER(\\s)?:\\[\\d+\\]\\s\\'(.*?)\\'\\s+PRIVILEGE\", 2, SyslogMessage)\n| extend Privilege = extract(@\"PRIVILEGE(\\s)?:\\[\\d+\\]\\s\\'(.*?)\\'\", 2, SyslogMessage)\n| extend SrcUserName = extract(@\"CLIENT USER(\\s)?:\\[\\d+\\]\\s\\'(.*?)\\'\", 2, SyslogMessage)\n| extend ClientTerminal = extract(@\"CLIENT TERMINAL(\\s)?:\\[\\d+\\] \\'(.*?)\\'\", 2, SyslogMessage)\n| extend Status = extract(@\"STATUS(\\s)?:\\[\\d+\\]\\s\\'(.*?)\\'\" , 2, SyslogMessage)\n| extend DbId = extract(@\"DBID(\\s)?:\\[\\d+\\]\\s\\'(.*?)\\'\" , 2, SyslogMessage)\n| extend SrcIpAddr = extract(@'HOST=(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})', 1, SyslogMessage)\n| extend SrcPortNumber = extract(@'PORT=(\\d{1,5})', 1, SyslogMessage)\n};\nlet oracledb_type_2 =() {\nSyslog\n| where SyslogMessage matches regex @\"STATEMENT(\\s)?:\\[\\d+\\]\"\n| extend EventVendor = 'Oracle'\n| extend EventProduct = \"Oracle Audit\"\n| extend MessageLength = extract(@'LENGTH(\\s)?:(\\s)?(\\d+)\\s+', 3, SyslogMessage)\n| extend SessionId = extract(@'SESSIONID(\\s)?:\\[\\d+\\]\\s+(\\d+)\\s+', 2, SyslogMessage)\n| extend EntryId = extract(@'ENTRYID(\\s)?:\\[\\d+\\]\\s+(\\d+)\\s+', 2, SyslogMessage)\n| extend Statement = extract(@'STATEMENT(\\s)?:\\[\\d+\\]\\s+(\\d+)\\s+', 2, SyslogMessage)\n| extend SrcUserName = extract(@'USERID(\\s)?:\\[\\d+\\]\\s+(.*?)\\s+USERHOST\"', 2, SyslogMessage)\n| extend SrcDvcHostname = extract(@'USERHOST(\\s)?:\\[\\d+\\]\\s+(.*?)\\s+(ACTION|TERMINAL)', 2, SyslogMessage)\n| extend Action = extract(@'ACTION(\\s)?:\\[\\d+\\]\\s+(.*?)\\s+RETURNCODE', 2, SyslogMessage)\n| extend ActionLength = extract(@'ACTION(\\s)?:\\[(\\d+)\\]\\s+(.*?)\\s+RETURNCODE', 2, SyslogMessage)\n| extend DbAction = case(Action == '1', 'CREATE TABLE',\n                         Action == '2', 'INSERT',\n                         Action == '3', 'SELECT',\n                         Action == '4', 'CREATE CLUSTER',\n                         Action == '5', 'ALTER CLUSTER',\n                         Action == '6', 'UPDATE',\n                         Action == '7', 'DELETE',\n                         Action == '8', 'DROP CLUSTER',\n                         Action == '9', 'CREATE INDEX',\n                         Action == '10', 'DROP INDEX',\n                         Action == '11', 'ALTER INDEX',\n                         Action == '12', 'DROP TABLE',\n                         Action == '13', 'CREATE SEQUENCE',\n                         Action == '14', 'ALTER SEQUENCE',\n                         Action == '15', 'ALTER TABLE',\n                         Action == '16', 'DROP SEQUENCE',\n                         Action == '17', 'GRANT OBJECT',\n                         Action == '18', 'REVOKE OBJECT',\n                         Action == '19', 'CREATE SYNONYM',\n                         Action == '20', 'DROP SYNONYM',\n                         Action == '21', 'CREATE VIEW',\n                         Action == '22', 'DROP VIEW',\n                         Action == '23', 'VALIDATE INDEX',\n                         Action == '24', 'CREATE PROCEDURE',\n                         Action == '25', 'ALTER PROCEDURE',\n                         Action == '26', 'LOCK',\n                         Action == '27', 'NO-OP',\n                         Action == '28', 'RENAME',\n                         Action == '29', 'COMMENT',\n                         Action == '30', 'AUDIT OBJECT',\n                         Action == '31', 'NOAUDIT OBJECT',\n                         Action == '32', 'CREATE DATABASE LINK',\n                         Action == '33', 'DROP DATABASE LINK',\n                         Action == '34', 'CREATE DATABASE',\n                         Action == '35', 'ALTER DATABASE',\n                         Action == '36', 'CREATE ROLLBACK SEG',\n                         Action == '37', 'ALTER ROLLBACK SEG',\n                         Action == '38', 'DROP ROLLBACK SEG',\n                         Action == '39', 'CREATE TABLESPACE',\n                         Action == '40', 'ALTER TABLESPACE',\n                         Action == '41', 'DROP TABLESPACE',\n                         Action == '42', 'ALTER SESSION',\n                         Action == '43', 'ALTER USER',\n                         Action == '44', 'COMMIT',\n                         Action == '45', 'ROLLBACK',\n                         Action == '46', 'SAVEPOINT',\n                         Action == '47', 'PL/SQL EXECUTE',\n                         Action == '48', 'SET TRANSACTION',\n                         Action == '49', 'ALTER SYSTEM',\n                         Action == '50', 'EXPLAIN',\n                         Action == '51', 'CREATE USER',\n                         Action == '52', 'CREATE ROLE',\n                         Action == '53', 'DROP USER',\n                         Action == '54', 'DROP ROLE',\n                         Action == '55', 'SET ROLE',\n                         Action == '56', 'CREATE SCHEMA',\n                         Action == '57', 'CREATE CONTROL FILE',\n                         Action == '59', 'CREATE TRIGGER',\n                         Action == '60', 'ALTER TRIGGER',\n                         Action == '61', 'DROP TRIGGER',\n                         Action == '62', 'ANALYZE TABLE',\n                         Action == '63', 'ANALYZE INDEX',\n                         Action == '64', 'ANALYZE CLUSTER',\n                         Action == '65', 'CREATE PROFILE',\n                         Action == '66', 'DROP PROFILE',\n                         Action == '67', 'ALTER PROFILE',\n                         Action == '68', 'DROP PROCEDURE',\n                         Action == '70', 'ALTER RESOURCE COST',\n                         Action == '71', 'CREATE MATERIALIZED VIEW LOG',\n                         Action == '72', 'ALTER MATERIALIZED VIEW LOG',\n                         Action == '73', 'DROP MATERIALIZED VIEW LOG',\n                         Action == '74', 'CREATE MATERIALIZED VIEW',\n                         Action == '75', 'ALTER MATERIALIZED VIEW',\n                         Action == '76', 'DROP MATERIALIZED VIEW',\n                         Action == '77', 'CREATE TYPE',\n                         Action == '78', 'DROP TYPE',\n                         Action == '79', 'ALTER ROLE',\n                         Action == '80', 'ALTER TYPE',\n                         Action == '81', 'CREATE TYPE BODY',\n                         Action == '82', 'ALTER TYPE BODY',\n                         Action == '83', 'DROP TYPE BODY',\n                         Action == '84', 'DROP LIBRARY',\n                         Action == '85', 'TRUNCATE TABLE',\n                         Action == '86', 'TRUNCATE CLUSTER',\n                         Action == '91', 'CREATE FUNCTION',\n                         Action == '92', 'ALTER FUNCTION',\n                         Action == '93', 'DROP FUNCTION',\n                         Action == '94', 'CREATE PACKAGE',\n                         Action == '95', 'ALTER PACKAGE',\n                         Action == '96', 'DROP PACKAGE',\n                         Action == '97', 'CREATE PACKAGE BODY',\n                         Action == '98', 'ALTER PACKAGE BODY',\n                         Action == '99', 'DROP PACKAGE BODY',\n                         Action == '100', 'LOGON',\n                         Action == '101', 'LOGOFF',\n                         Action == '102', 'LOGOFF BY CLEANUP',\n                         Action == '103', 'SESSION REC',\n                         Action == '104', 'SYSTEM AUDIT',\n                         Action == '105', 'SYSTEM NOAUDIT',\n                         Action == '106', 'AUDIT DEFAULT',\n                         Action == '107', 'NOAUDIT DEFAULT',\n                         Action == '108', 'SYSTEM GRANT',\n                         Action == '109', 'SYSTEM REVOKE',\n                         Action == '110', 'CREATE PUBLIC SYNONYM',\n                         Action == '111', 'DROP PUBLIC SYNONYM',\n                         Action == '112', 'CREATE PUBLIC DATABASE LINK',\n                         Action == '113', 'DROP PUBLIC DATABASE LINK',\n                         Action == '114', 'GRANT ROLE',\n                         Action == '115', 'REVOKE ROLE',\n                         Action == '116', 'EXECUTE PROCEDURE',\n                         Action == '117', 'USER COMMENT',\n                         Action == '118', 'ENABLE TRIGGER',\n                         Action == '119', 'DISABLE TRIGGER',\n                         Action == '120', 'ENABLE ALL TRIGGERS',\n                         Action == '121', 'DISABLE ALL TRIGGERS',\n                         Action == '122', 'NETWORK ERROR',\n                         Action == '123', 'EXECUTE TYPE',\n                         Action == '128', 'FLASHBACK',\n                         Action == '129', 'CREATE SESSION',\n                         Action == '157', 'CREATE DIRECTORY',\n                         Action == '158', 'DROP DIRECTORY',\n                         Action == '159', 'CREATE LIBRARY',\n                         Action == '160', 'CREATE JAVA',\n                         Action == '161', 'ALTER JAVA',\n                         Action == '162', 'DROP JAVA',\n                         Action == '163', 'CREATE OPERATOR',\n                         Action == '164', 'CREATE INDEXTYPE',\n                         Action == '165', 'DROP INDEXTYPE',\n                         Action == '167', 'DROP OPERATOR',\n                         Action == '168', 'ASSOCIATE STATISTICS',\n                         Action == '169', 'DISASSOCIATE STATISTICS',\n                         Action == '170', 'CALL METHOD',\n                         Action == '171', 'CREATE SUMMARY',\n                         Action == '172', 'ALTER SUMMARY',\n                         Action == '173', 'DROP SUMMARY',\n                         Action == '174', 'CREATE DIMENSION',\n                         Action == '175', 'ALTER DIMENSION',\n                         Action == '176', 'DROP DIMENSION',\n                         Action == '177', 'CREATE CONTEXT',\n                         Action == '178', 'DROP CONTEXT',\n                         Action == '179', 'ALTER OUTLINE',\n                         Action == '180', 'CREATE OUTLINE',\n                         Action == '181', 'DROP OUTLINE',\n                         Action == '182', 'UPDATE INDEXES',\n                         Action == '183', 'ALTER OPERATOR',\n                         Action == '197', 'PURGE USER_RECYCLEBIN',\n                         Action == '198', 'PURGE DBA_RECYCLEBIN',\n                         Action == '199', 'PURGE TABLESAPCE',\n                         Action == '200', 'PURGE TABLE',\n                         Action == '201', 'PURGE INDEX',\n                         Action == '202', 'UNDROP OBJECT',\n                         Action == '204', 'FLASHBACK DATABASE',\n                         Action == '205', 'FLASHBACK TABLE',\n                         Action == '206', 'CREATE RESTORE POINT',\n                         Action == '207', 'DROP RESTORE POINT',\n                         Action == '208', 'PROXY AUTHENTICATION ONLY',\n                         Action == '209', 'DECLARE REWRITE EQUIVALENCE',\n                         Action == '210', 'ALTER REWRITE EQUIVALENCE',\n                         Action == '211', 'DROP REWRITE EQUIVALENCE',\n                         'UNKNOWN ACTION'\n                         )\n| extend ReturnCode = extract(@'RETURNCODE(\\s)?:\\[\\d+\\]\\s+(\\d+)\\s+', 2, SyslogMessage)\n| extend ObjCreator = extract(@'OBJ(\\s)?:\\[\\d+\\]\\s+(.*?)\\s+OBJ', 2, SyslogMessage)\n| extend ObjName = extract(@'OBJ.*?OBJ(\\s)?:\\[\\d+\\]\\s+(.*?)\\s+OS', 2, SyslogMessage)\n| extend OsUserId = extract(@'OS(\\s)?:\\[\\d+\\]\\s+(.*?)\\s+', 2, SyslogMessage)\n| extend ClientTerminal =  extract(@'TERMINAL(\\s)?:\\[\\d+\\]\\s+(.*?)\\s+ACTION', 2, SyslogMessage)\n| extend DbId = extract(@'DBID(\\s)?:\\[\\d+\\]\\s+(\\d+)', 2, SyslogMessage)\n| extend SrcIpAddr = extract(@'HOST=(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})', 1, SyslogMessage)\n| extend SrcPortNumber = extract(@'PORT=(\\d{1,5})', 1, SyslogMessage)\n};\nunion isfuzzy=true oracledb_type_1, oracledb_type_2\n| project TimeGenerated\n        , EventVendor\n        , EventProduct\n        , SeverityLevel\n        , MessageLength\n        , Action\n        , ActionLength\n        , DbAction\n        , DstUserName\n        , Privilege\n        , SrcUserName\n        , ClientTerminal\n        , Status\n        , DbId\n        , SessionId\n        , EntryId\n        , Statement\n        , SrcDvcHostname\n        , SrcIpAddr\n        , SrcPortNumber\n        , ReturnCode\n        , ObjCreator\n        , ObjName\n        , OsUserId\n",
            "version": 1
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Action by Ip",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime)\n| where isnotempty(DbAction)\n| where isnotempty(SrcIpAddr)\n| where DbAction in~ ('SELECT', 'DROP', 'INSERT')\n| extend TableName = replace(@'[,\\(\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\s(.*?)\\s', 2, Action))\n| where isnotempty(TableName)\n| where TableName !~ 'select'\n| summarize TablesAffected = makeset(TableName) by SrcIpAddr, DbAction\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches sources from which DbActions were made."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,DefenseEvasion,Collection,Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Action by user",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime)\n| where isnotempty(DbAction)\n| where isnotempty(DstUserName)\n| where DbAction in~ ('SELECT', 'DROP', 'INSERT')\n| extend TableName = replace(@'[,\\(\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\s(.*?)\\s', 2, Action))\n| where isnotempty(TableName)\n| where TableName !~ 'select'\n| summarize TablesAffected = makeset(TableName) by DstUserName, DbAction\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches actions made by user."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,DefenseEvasion,Collection,Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Active Users",
            "category": "Hunting Queries",
            "query": "OracleDatabaseAuditEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(Action) and isnotempty(DstUserName) and isnotempty(SrcIpAddr)\n| summarize count() by DstUserName\n| order by count_\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query for searching active database user accounts."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,DefenseEvasion"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Users connected to databases during non-operational hours.",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime)\n| where DbAction =~ 'CONNECT'\n| where isnotempty(DstUserName)\n| extend day_of_week = dayofweek(TimeGenerated)\n| extend hour_of_day = hourofday(TimeGenerated)\n| where day_of_week in~ ('0.00:00:00', '6.00:00:00') or hour_of_day between (18 .. 8)\n| project TimeGenerated, DstUserName, SrcIpAddr\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for users who have connected to databases during non-operational hours."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,DefenseEvasion,Collection,Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Dropped Tables",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime)\n| where DbAction =~ 'DROP'\n| extend TableName = replace(@'[,\\(\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\s(.*?)\\s', 2, Action))\n| where isnotempty(TableName)\n| where TableName !~ 'select'\n| project TimeGenerated, DstUserName, TableName\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for dropped tables."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Inactive Users",
            "category": "Hunting Queries",
            "query": "let lbtime_30d = 30d;\nlet lbtime_1d = 1d;\nlet known_users_gt_30d = OracleDatabaseAuditEvent\n| where TimeGenerated < ago(lbtime_30d)\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| summarize makeset(DstUserName);\nlet known_users_ls_30d = OracleDatabaseAuditEvent\n| where TimeGenerated between (ago(lbtime_30d) .. ago(lbtime_1d))\n| where isnotempty(DstUserName)\n| where isnotempty(Action)\n| summarize makeset(DstUserName);\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime_1d)\n| where isnotempty(DstUserName)\n| where DbAction =~ 'CONNECT'\n| where DstUserName in (known_users_gt_30d)\n| where DstUserName !in (known_users_ls_30d)\n| project DstUserName\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query for searching user accounts which last activity was more than 30 days ago."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Audit large queries",
            "category": "Hunting Queries",
            "query": "let lbtime_30d = 30d;\nlet lbtime_1d = 1d;\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime_30d)\n| where isnotempty(ActionLength)\n| summarize avg_action_length = avg(toint(ActionLength))\n| extend a = 1\n| join (OracleDatabaseAuditEvent\n  | where TimeGenerated > ago(lbtime_1d)\n  | where isnotempty(ActionLength)\n  | extend a = 1) on a\n| where toint(ActionLength) > 2*avg_action_length\n| project avg_action_length, ActionLength, Action, DstUserName,SrcIpAddr\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query for auditing large queries."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,DefenseEvasion"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Top tables queries",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime)\n| where DbAction =~ 'SELECT'\n| extend TableName = replace(@'[,\\(\\)]', '', extract(@'(?i)SELECT(.*?)FROM\\s(.*?)\\s', 2, Action))\n| where isnotempty(TableName)\n| where TableName !~ 'select'\n| summarize count() by TableName, DstUserName\n| order by count_\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
			{
                "name": "description",
                "value": "Query searches for tables queries."
              },
              {
                "name": "tactics",
                "value": "Collection"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Users with new privileges",
            "category": "Hunting Queries",
            "query": "let lbtime_30d = 30d;\nlet lbtime_1d = 1d;\nOracleDatabaseAuditEvent\n| where TimeGenerated between (ago(lbtime_30d) .. ago(lbtime_1d))\n| where isnotempty(Privilege) and isnotempty(DstUserName)\n| summarize Privileges = makeset(Privilege) by DstUserName\n| join (OracleDatabaseAuditEvent\n      | where TimeGenerated > ago(lbtime_1d)\n      | where isnotempty(DstUserName) and isnotempty(Privilege)\n      | project DstUserName, Privilege\n      ) on DstUserName\n|mv-expand Privileges\n|extend Privileges = tostring(Privileges)\n| where Privilege != Privileges",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query for searching user accounts whith new privileges."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,PrivilegeEscalation"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleDatabaseAudit Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleDBAudit - Users Privileges Review",
            "category": "Hunting Queries",
            "query": "let lbtime = 30d;\nOracleDatabaseAuditEvent\n| where TimeGenerated > ago(lbtime)\n| where isnotempty(DstUserName)\n| where isnotempty(Privilege)\n| summarize makeset(Privilege) by DstUserName\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for user accounts and their privileges."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,PrivilegeEscalation"
              }
            ]
          }
        }
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "contentId": "[variables('_sourceId')]",
        "version": "1.0.5",
        "kind": "Solution",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "Oracle Database Audit",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Amarnath Pamidi",
          "email": "v-ampami@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_OracleDatabaseAudit')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditConnectFromExternalIp')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditDropManyTables')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditForbiddenSrcIpAddr')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditNewIpForUser')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditNewUserDetected')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditQueryOnSensitiveTable')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditRareUserActivity')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditSQLInjectionPatterns')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditSelectOnManyTables')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleDBAuditShutdownServer')]",
              "version": "1.0.5"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_OracleDatabaseAuditConnector')]",
              "version": "1.0.5"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_OracleDatabaseAuditEvent')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditActionsByIp')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditActionsByUser')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditActiveUsers')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditDbConnectNonOperationalTime')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditDroppedTables')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditInactiveUsers')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditLargeQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditListOfTablesQueried')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditUsersNewPrivilegesAdded')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleDBAuditUsersPrivilegesReview')]",
              "version": "1.0.5"
            }
          ]
        },
        "categories": {
          "domains": [
            "Application"
          ]
        },
        "firstPublishDate": "2021-03-26",
        "providers": [
          "Oracle"
        ]
      }
    }
  ],
  "outputs": {}
}
